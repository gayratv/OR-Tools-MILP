# Техническое задание: генерация школьного расписания (с мягкими ограничениями)

## 1. Глоссарий

* **Класс** — группа учеников одного года обучения (например, 5А).
* **Подгруппа** — деление класса на 2 части для отдельных предметов.
* **Слот** — комбинация дня и урока (например, понедельник, 3-й урок).
* **Учебный план** — количество часов в неделю, которое должно быть проведено по каждому предмету в конкретный год обучения.
* **Сложный предмет** — предмет, требующий высокой концентрации (например, математика, физика, иностранный язык).
* **Жёсткие ограничения** — условия, которые нельзя нарушать.
* **Мягкие ограничения** — условия, нежелательные к нарушению; учитываются в целевой функции через штрафы.

---

## 2. Исходные данные

2.1 **Предметы**

* Загружаются из базы данных.
* Примеры: математика, информатика, английский, труд, физкультура.
* Атрибуты: идентификатор, название, уровень сложности, признак «делится на подгруппы».

2.2 **Учителя**

* Каждый учитель может преподавать один или несколько предметов.
* Уникальный идентификатор учителя.
* **Доступность (жёстко):** список дней/слотов, когда учитель может вести занятия.
* **Нежелательные слоты (мягко):** список пар (день, урок), которых учитель предпочитает избегать.

2.3 **Годы обучения** — с **5 по 11 классы**.

2.4 **Классы** — например: 5А, 5Б, 6А, … 11Б; у каждого — ID, параллель и буква.

2.5 **Учебный план**

* Для каждого класса: целочисленное число часов в неделю по каждому предмету.
* Для предметов: иностранный язык, информатика, труд — занятия проводятся в **подгруппах**.

2.6 **Подгруппы**

* Деление на 2 подгруппы применяется **только** для: иностранный язык, информатика, труд.
* Совместимые комбинации для одновременного проведения:

  * иностранный язык ↔ иностранный язык
  * информатика ↔ иностранный язык
  * труд ↔ труд
* Желательно ставить уроки одновременно для обеих подгрупп.
* Уроки подгрупп синхронизируются и не пересекаются с общеклассными уроками.

2.7 **Закрепление учителей**

* За каждым классом и предметом закреплён учитель; для подгрупп — учитель на подгруппу.

---

## 3. Ограничения расписания

### 3.1 Жёсткие ограничения

* Учёба проводится **5 дней в неделю**, в день **не более 7 уроков**.
* Учитель ведёт не более **35 уроков в неделю** и в один слот — только один урок.
* Учитываются days-off и недоступности учителей (в эти слоты назначать нельзя).
* Для класса в слот `(день, урок)` — не более одного предмета (учитывая совместимость подгрупп).
* Для каждого класса и предмета — **не более одного урока в день**.
* Деление на подгруппы — только для перечисленных предметов.

### 3.2 Мягкие ограничения

* **Нежелательные слоты учителей.** Пример: Иванов — «Понедельник, урок 1»; Сидоров — «Пятница, урок 7».
* **Не ставить два сложных предмета подряд** и **не размещать сложные предметы в последние слоты дня**.
* **Баланс нагрузки по дням** (избегать концентрации часов одного предмета в одном дне).
* **Избегать одинакового предмета в соседние дни для одного класса.**

  * Пример: если у 7А в понедельник была **история**, то **нежелательно** ставить **историю** во вторник.

> Все мягкие ограничения входят в целевую функцию через штрафы с настраиваемыми весами.

---

## 4. Формализация для MILP

### 4.1 Данные

Условные обозначения входных данных и параметров:

* `H[c,p]` — количество часов в неделю по предмету `p` для класса `c` (например: H\[5А, Математика] = 4).
* `A[c,p]` — учитель, закреплённый за предметом `p` в классе `c` (например: A\[5А, Математика] = Иванов).
* `hard(p)` — вес сложности предмета от 0 до 100 (например: математика = 90, физика = 80, иностранный язык = 70, труд = 20).
* `H_end` — множество последних уроков дня (например: уроки 6 и 7).
* `U[t]` — доступные дни и часы работы учителя `t` (например: U\[Иванов] = {Пн: 2–6, Вт: 1–7}, U\[Сидоров] = {Пн: 1–5, Ср: 3–7}); используется как жёсткое ограничение.
* `U_soft[t]` — нежелательные (мягкие) слоты учителя `t` (например: U\_soft\[Иванов] = {Пн:1}, U\_soft\[Сидоров] = {Пт:7}); используется как мягкое ограничение.
* `w[c,p,d]` — бинарный индикатор, что в классе `c` предмет `p` стоит хотя бы один раз в день `d`.

### 4.2 Переменные

Индексы:

* `c` — класс (например, 5А, 6Б).
* `g` — подгруппа (1 или 2).
* `p` — предмет.
* `d` — день недели (1–5).
* `h` — номер урока (1–7).

Переменные (включая вспомогательные):

* `s[c,d,h] ∈ {0,1}` — занятость слота для класса c в день d, урок h (см. формулы §4.5).
* a[c,d,h] ∈ {0,1} — к моменту h уже был хотя бы один урок (до/в h).
* b[c,d,h] ∈ {0,1} — начиная с h до конца дня есть хотя бы один урок.
* g[c,d,h] ∈ {0,1} — «окно» (между первым и последним уроком, без урока в h).

* `w[c,p,d] ∈ {0,1}` — вспомогательная переменная, равна 1, если у класса `c` есть хотя бы один урок по предмету `p` в день `d`. Используется для мягкого ограничения «не ставить предмет в соседние дни».
* `x[c,p,d,h] ∈ {0,1}` — у класса `c` предмет `p` в день `d`, урок `h`.
* `x[c,g,p,d,h] ∈ {0,1}` — то же для подгруппы `g` класса `c`.
* `y[t,d,h] ∈ {0,1}` — учитель `t` ведёт урок в слот `(d,h)`.
* `z_teacher_undes[t,d,h] ∈ {0,1}` — нарушение нежелательного слота учителя.
* `z_hard_end[c,p,d,h] ∈ {0,1}` — сложный предмет в позднем слоте.
* `z_consec_hard[c,d,h] ∈ {0,1}` — два сложных подряд.
* `z_nextday_same[c,p,d] ∈ {0,1}` — тот же предмет `p` и на следующий день.
* `z_gaps[c,d]` — целочисленная переменная, определяющая количество пустых слотов (окон) между первым и последним уроком у класса `c` в день `d`; суммарное значение по всем дням минимизируется в целевой функции.

### 4.3 Жёсткие ограничения (схема)

1. `∑_{d,h} x[c,p,d,h] = H[c,p]`.
2. `∑_{p} x[c,p,d,h] ≤ 1`.
3. `∑_{c,p} A[c,p]=t · x[c,p,d,h] ≤ 1`.
4. `∑_{d,h,c,p} A[c,p]=t · x[c,p,d,h] ≤ 35`.
5. `x[c,p,d,h] = 0`, если `t=A[c,p]` недоступен.
6. `∑_{h} x[c,p,d,h] ≤ 1`.

### 4.4 Мягкие ограничения (схема)

* `z_teacher_undes[t,d,h] ≥ y[t,d,h]` для `(t,d,h) ∈ U_soft[t]`.
* `z_hard_end[c,p,d,h] ≥ x[c,p,d,h] · hard(p)` для `h ∈ H_end`.
* `z_consec_hard[c,d,h] ≥ hard_at(c,d,h) + hard_at(c,d,h+1) - 1`.
* `z_nextday_same[c,p,d] ≥ w[c,p,d] + w[c,p,d+1] - 1`.

### 4.5 Взаимосвязи переменных

**Упрощение для `s[c,d,h]`**
Вместо пары неравенств можно использовать одно равенство, так как по 4.3.2 в слоте у класса не более одного предмета:

* `s[c,d,h] = ∑_{p} x[c,p,d,h]`

* частный случай: `s[c,d,1] = ∑_{p} x[c,p,d,1]`

* `y[t,d,h] = ∑_{c,p} [A[c,p]=t] · x[c,p,d,h]`.

* `w[c,p,d]` определяется системой линейных уравнений:

  * `∑_{h} x[c,p,d,h] ≥ w[c,p,d]`.
  * `M·w[c,p,d] ≥ ∑_{h} x[c,p,d,h]`, где M = максимальное число уроков в день. Таким образом, `w[c,p,d]` принимает 1, если хотя бы один `x[c,p,d,h] = 1`, и 0 иначе.

**Уравнения для **\`\`** (количество «окон» у класса в день):** Пусть `H=7` — число уроков в дне, а `s[c,d,h] := ∑_{p} x[c,p,d,h]` (по 4.3.2 имеем `s[c,d,h] ∈ {0,1}`). Вводим вспомогательные бинарные переменные префикса/суффикса:

* `a[c,d,h] ∈ {0,1}` — к моменту `h` уже был хотя бы один урок в день `d` (до или в h).
* `b[c,d,h] ∈ {0,1}` — начиная с `h` до конца дня есть хотя бы один урок в день `d`.
* `g[c,d,h] ∈ {0,1}` — слот `h` является «окном» (между первым и последним уроком).

Связи для префикса `a`:

* `a[c,d,1] = s[c,d,1]`.
* Для `h = 2..H`: `a[c,d,h] ≥ a[c,d,h-1]`, `a[c,d,h] ≥ s[c,d,h]`, `a[c,d,h] ≤ a[c,d,h-1] + s[c,d,h]`.

Связи для суффикса `b`:

* `b[c,d,H] = s[c,d,H]`.
* Для `h = 1..H-1`: `b[c,d,h] ≥ b[c,d,h+1]`, `b[c,d,h] ≥ s[c,d,h]`, `b[c,d,h] ≤ b[c,d,h+1] + s[c,d,h]`.

Определение «окна» в слоте `h`:

* `g[c,d,h] ≥ a[c,d,h] + b[c,d,h] - 1 - s[c,d,h]`  (внутри интервала между первым и последним уроком и без урока в `h`).
* `g[c,d,h] ≤ a[c,d,h]`.
* `g[c,d,h] ≤ b[c,d,h]`.
* `g[c,d,h] + s[c,d,h] ≤ 1`.

Агрегация по дню:

* `z_gaps[c,d] = ∑_{h=1}^{H} g[c,d,h]`.

### 4.6 Целевая функция

Цель — минимизировать суммарные штрафы за нарушения мягких ограничений и показатели неудобства.

Минимизировать:

```
Σ w1·z_teacher_undes + Σ w2·z_hard_end + Σ w3·z_consec_hard + Σ w4·z_nextday_same
+ w5·(окна у классов и учителей) + w6·(дисбаланс нагрузки)
```

---

## 5. Технические детали реализации

* **Язык:** Python; библиотеки: PuLP / OR-Tools.
* **Данные:** JSON/SQL/CSV.
* **Выход:** Excel, PDF, лог нарушений мягких ограничений.

---

## 6. Чеклист

*

---

## 7. Пример входных данных

### Таблица учителей

| ID | ФИО           | Предметы (ID) | Доступные дни | Нежелательные слоты |
| -- | ------------- | ------------- | ------------- | ------------------- |
| T1 | Иванов И.И.   | P1            | Пн–Пт         | Пн, урок 1          |
| T2 | Петров П.П.   | P2, P3        | Вт–Пт         | —                   |
| T3 | Сидоров С.С.  | P4            | Пн, Ср, Пт    | Пт, урок 7          |
| T4 | Смирнова А.А. | P5            | Пн–Пт         | —                   |

### Таблица предметов (фрагмент)

| ID | Название        | Сложность | Деление |
| -- | --------------- | --------- | ------- |
| P1 | Математика      | Высокая   | Нет     |
| P2 | Информатика     | Средняя   | Да      |
| P3 | Английский язык | Высокая   | Да      |
| P4 | Труд            | Низкая    | Да      |
| P5 | Физкультура     | Низкая    | Нет     |
