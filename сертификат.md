Первый выпуск сертификата (один раз)

Поднимите всё без HTTPS-блока (или оставьте как есть — важно, чтобы порт 80 был доступен):

docker compose up -d


Выпустите сертификат через webroot:

docker compose run --rm certbot certonly --webroot \
  -w /var/www/certbot \
  -d "$DOMAIN" \
  --email "$LETSENCRYPT_EMAIL" --agree-tos --no-eff-email


Перезапустите Nginx, чтобы он подхватил файлы:

docker compose restart nginx


Проверка:

curl -I https://$DOMAIN/


Дальше контейнер certbot сам будет продлевать сертификаты (командой certbot renew) и хранить их в volume certbot-etc. Продление не требует перезапуска Nginx — но после фактического обновления сертификата можно добавить --deploy-hook "nginx -s reload" при желании (через свой скрипт/обёртку).


Вариант A (рекомендую): cron на хосте (просто и надёжно)

Убедитесь, что контейнеры уже подняты (docker compose up -d) и сертификат выпущен.

Откройте crontab:

crontab -e


Добавьте задачу (2 раза в день проверять продление и при успехе перегружать Nginx):

# Certbot renew + reload nginx (каждые 12 часов)
0 */12 * * * cd /home/user/mysql-on-vps && /usr/bin/docker compose run --rm certbot certbot renew --webroot -w /var/www/certbot --quiet && /usr/bin/docker compose exec -T nginx nginx -s reload


-T убирает псевдотерминал (для cron). Путь к проекту поменяйте на свой.

