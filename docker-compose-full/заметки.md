6) (Опционально) Включить TLS для внешних клиентов

Рекомендуется шифровать соединение.

сгенерируйте сертификаты (самоподписанные либо от вашего CA/Let’s Encrypt; ниже — быстрый вариант для теста):

mkdir -p mysql/certs
openssl genrsa -out mysql/certs/ca-key.pem 4096
openssl req -new -x509 -nodes -key mysql/certs/ca-key.pem -out mysql/certs/ca.pem -days 365 -subj "/CN=MySQL-CA"
openssl genrsa -out mysql/certs/server-key.pem 2048
openssl req -new -key mysql/certs/server-key.pem -out mysql/certs/server.csr -subj "/CN=$(curl -s ifconfig.me || echo localhost)"
openssl x509 -req -in mysql/certs/server.csr -CA mysql/certs/ca.pem -CAkey mysql/certs/ca-key.pem -CAcreateserial -out mysql/certs/server-cert.pem -days 365
chmod 600 mysql/certs/*key.pem



Находясь в каталоге с вашими файлами (docker-compose.yml и .env):
docker compose up -d

Проверить, что переменные подставились
docker compose config

Проверить, что порт открыт на VPS
netstat -tuln | grep 45321

Проверить соединение клиентом MySQL
mysql -h 127.0.0.1 -P 45321 -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" "$MYSQL_DATABASE"

sudo apt update
sudo apt install mysql-client -y

docker exec -it mysql8 mysql -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" "$MYSQL_DATABASE"


set -a
source .env
set +a


scp -i ~/.ssh/id_rsa -r ./mysql user@vps.example.com:/home/user/

scp -i ~/.ssh/vps_key -r ./mysql-on-vps user@<VPS_IP_OR_HOSTNAME>:/home/user/


Запуск
# из корня проекта
docker compose up -d --build

curl http(s)://<ваш_домен_или_IP>/
# или напрямую если без nginx: curl http://<IP_VPS>:3000/


===================
Быстрая проверка

Перезапуск:

docker compose down && docker compose up -d


Изнутри контейнера:

docker exec -it mysql8 mysql --ssl-mode=REQUIRED -uroot -p"$MYSQL_ROOT_PASSWORD" \
  -e "SHOW VARIABLES LIKE 'have_ssl'; SHOW STATUS LIKE 'Ssl_cipher';"


С удалённой машины (скопируйте ca.pem):

mysql --ssl-mode=VERIFY_IDENTITY --ssl-ca=/путь/к/ca.pem \
  -h <ваш_домен> -P <ваш_порт> -u appuser -p

===========
С удалённой машины

Скопируйте ca.pem на клиентскую машину (например, в ~/.mysql/ca.pem) и подключайтесь:

mysql --ssl-mode=VERIFY_CA --ssl-ca=/path/to/ca.pem \
  -h example.com -P 45321 -u appuser -p


REQUIRED — примет любой валидный TLS (без проверки CA/имени хоста).

VERIFY_CA — проверит, что сертификат подписан вашим CA.

VERIFY_IDENTITY — дополнительно проверит совпадение имени хоста (CN/SAN) с -h.

Если вы правильно указали subjectAltName=DNS:example.com, смело используйте --ssl-mode=VERIFY_IDENTITY.