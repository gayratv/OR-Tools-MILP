Для выпуска сертификата Let’s Encrypt (первый раз) в вашей схеме с nginx + certbot (webroot) нужно сделать такие шаги:

# 1. Подготовка

Убедитесь, что в .env указаны:

DOMAIN=example.com
LETSENCRYPT_EMAIL=admin@example.com


У вашего домена есть A-запись, которая смотрит на публичный IP VPS.

Порт 80 открыт наружу (sudo ufw allow 80/tcp или аналогичное правило iptables).

# 2. Запуск сервисов

Поднимите стек без сертификата (nginx работает на 80-м порту, выдаёт challenge-файлы):

docker compose up -d

# 3. Выпуск сертификата

Выполните разовую команду для certbot:

docker compose run --rm certbot certonly \
  --webroot -w /var/www/certbot \
  -d "$DOMAIN" \
  --email "$LETSENCRYPT_EMAIL" --agree-tos --no-eff-email


Что делает эта команда:

--webroot -w /var/www/certbot → указывает папку для ACME-challenge (уже смонтирована в nginx).

-d "$DOMAIN" → домен, на который выпускается сертификат.

--email → почта для уведомлений.

--agree-tos → принять лицензию.

--no-eff-email → не подписываться на рассылку.

При успехе certbot сохранит ключи и сертификаты в volume certbot-etc внутри проекта.

# 4. Перезапуск Nginx

После успешного выпуска перезапустите nginx, чтобы он подхватил файлы:

docker compose restart nginx

# 5. Проверка
curl -I https://$DOMAIN/


или просто откройте https://ваш-домен в браузере — должен быть валидный HTTPS-сертификат.

# 6. Автопродление

Контейнер certbot в docker-compose уже крутит certbot renew раз в 12 часов.
Вы можете добавить крон/таймер, чтобы после продления делать nginx -s reload.


# Скрипт для хоста (удобно вешать на cron/systemd)
Создайте файл scripts/renew-and-reload.sh:

Сделайте его исполнимым:

chmod +x scripts/renew-and-reload.sh

# Автозапуск через cron (проще всего)
Откройте crontab:

crontab -e


Добавьте строку (2 раза в день):

0 */12 * * * /home/user/mysql-on-vps/scripts/renew-and-reload.sh >> /home/user/mysql-on-vps/renew.log 2>&1


Путь подставьте свой. Лог будет в renew.log.