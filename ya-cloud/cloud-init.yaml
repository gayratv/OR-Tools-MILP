#cloud-config
# Этот файл используется cloud-init для настройки ВМ после первого запуска.
datasource:
  Ec2:
    strict_id: false
ssh_pwauth: no
users:
  - name: yc-user
    groups: [ 'sudo', 'docker' ]
    shell: /bin/bash
    sudo: [ 'ALL=(ALL) NOPASSWD:ALL' ]
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMsT2ARMza/hqHGe2QqSAPTlUhh3yUimuVAXXjqsuLlm root@SOLIDWORKS2022

write_files:
  - path: "/usr/local/etc/yc-install.sh"
    owner: yc-user:yc-user
    permissions: "0755"
    content: |
      #!/bin/bash

      # CLI
      echo "Installing Yandex Cloud CLI"
      curl \
        --silent \
        --show-error \
        --location \
        https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
      VM_ID=$(curl --silent http://169.254.169.254/latest/meta-data/instance-id)

      # Save YC params
      echo "Saving YC params to the ~/.bashrc"
      cat << EOF >> $HOME/.bashrc
        # Настройки YC CLI
        export YC_CLI_VM_ID="${VM_ID:-unknown}"
        # … другие нужные строки …
      EOF
    defer: true
runcmd:
  - [su, yc-user, -c, "/usr/local/etc/yc-install.sh"]
